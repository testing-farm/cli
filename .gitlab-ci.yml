---
stages:
  - ðŸ“¦ build
  - ðŸ”Ž test
  - ðŸš€ deploy

image: quay.io/testing-farm/python-ci-image:2023-05-23-73a71064

variables:
  IMAGE: quay.io/testing-farm/cli

#
# Mark tests to run for merge requests
#
.merge-request:
  rules:
    - if: $CI_MERGE_REQUEST_IID

#
# Mark tests to run on merge to main
#
.main:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

#
# Mark tests to run on tags
#
.tag:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/

#
# Common container build job
#
.container:
  image: quay.io/testing-farm/cli:latest
  script:
    - >
      testing-farm request \
        --git-url https://gitlab.com/testing-farm/tests.git \
        --git-ref main \
        --environment GIT_URL=${CI_MERGE_REQUEST_PROJECT_URL:-CI_PROJECT_URL} \
        --environment GIT_REF=${CI_MERGE_REQUEST_REF_PATH:-CI_COMMIT_SHA} \
        --environment TARGET_IMAGE=$IMAGE:$IMAGE_TAG \
        --environment CONTAINER_FILE=container/Dockerfile \
        --environment BUILD_ENV=container/build.env \
        --environment ENABLE_PUSH=yes \
        --secret AUTH_JSON=$QUAY_AUTH_JSON_BASE64 \
        --plan /container/build

#
# ðŸ“¦ build
#
container:
  extends: [.merge-request, .container]
  stage: ðŸ“¦ build
  variables:
    IMAGE_TAG: $CI_PIPELINE_ID

#
# ðŸ”Ž test
#
pre-commit:
  extends: .merge-request
  stage: ðŸ”Ž test
  needs: []
  script:
    - make pre-commit

tox:
  extends: .merge-request
  stage: ðŸ”Ž test
  needs: []
  script:
    - make tox

tmt:
  extends: .merge-request
  stage: ðŸ”Ž test
  needs: ["container"]
  image: quay.io/testing-farm/cli:latest
  script:
    - testing-farm request -c distro=alpine -e IMAGE_TAG=$CI_PIPELINE_ID
                           --git-url $CI_MERGE_REQUEST_PROJECT_URL
                           --git-ref $CI_MERGE_REQUEST_REF_PATH
goss:
  extends: .merge-request
  stage: ðŸ”Ž test
  needs: ["container"]
  image: quay.io/testing-farm/cli:$CI_PIPELINE_ID
  script:
    - make goss

#
# ðŸš€ deploy
#
publish/container/latest:
  extends: [.main, .container]
  stage: ðŸš€ deploy
  variables:
    IMAGE_TAG: latest

publish/container/version:
  extends: [.main, .container]
  stage: ðŸš€ deploy
  before_script:
    - export IMAGE_TAG="v$(poetry version -s | tr '+' '.')-$CI_COMMIT_SHORT_SHA"

publish/container/tag:
  extends: [.tag, .container]
  stage: ðŸš€ deploy
  before_script:
    - export IMAGE_TAG="v$(poetry version -s)"

publish/pypi:
  extends: .tag
  stage: ðŸš€ deploy
  script:
    # TODO: remove once in python ci image
    - dnf -y install python3-poetry-dynamic-versioning
    - poetry config repositories.tft-cli https://upload.pypi.org/legacy/
    - poetry publish --build --repository tft-cli
